(()=>{var o={n:e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},d:(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:(o,e)=>Object.prototype.hasOwnProperty.call(o,e),r:o=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})}},e={};(()=>{"use strict";o.r(e);const t=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/app"];var n=o.n(r);const s=flarum.core.compat["common/components/Button"];var a=o.n(s);const i=flarum.core.compat["common/components/LinkButton"];var c=o.n(i);const p=flarum.core.compat["common/components/TextEditor"];var u=o.n(p);const l=flarum.core.compat["common/helpers/listItems"];var d=o.n(l);const f=flarum.core.compat["forum/components/Composer"];var h=o.n(f);const v=flarum.core.compat["forum/components/DiscussionComposer"];var g=o.n(v);const y=flarum.core.compat["forum/components/IndexPage"];var b=o.n(y);const C=flarum.core.compat["forum/states/ComposerState"];var w=o.n(C);function P(){return P=Object.assign?Object.assign.bind():function(o){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r])}return o},P.apply(this,arguments)}function x(o,e){return x=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(o,e){return o.__proto__=e,o},x(o,e)}const O=flarum.core.compat["common/components/Page"];var T=o.n(O);const N=flarum.core.compat["common/components/LoadingIndicator"];var M=o.n(N);const k=flarum.core.compat["common/utils/extractText"];var D=o.n(k);const j=flarum.core.compat["common/utils/Stream"];var S=o.n(j),H=function(o){return n().store.all("tags").find((function(e){return 0===e.slug().localeCompare(o,void 0,{sensitivity:"base"})}))};function I(){var o,e=null==(o=flarum.extensions["fof-byobu"])||null==(o=o.discussions)?void 0:o.PrivateDiscussionComposer;return e&&n().composer.bodyMatches(e)}var _=function(o){var e,t;function r(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return(e=o.call.apply(o,[this].concat(r))||this).loading=!1,e.handlers={},e}t=o,(e=r).prototype=Object.create(t.prototype),e.prototype.constructor=e,x(e,t);var s=r.prototype;return s.currentTag=function(){var o=this;return new Promise((function(e){var t=m.route.param().slug;if(!t)return e(null);var r=H(t);if(r)return e(r);o.loading=!0,n().store.find("tags",t,{include:"children,children.parent,parent,state"}).then((function(){o.loading=!1,e(H(t))}))}))},s.oninit=function(e){var t=this;o.prototype.oninit.call(this,e),n().setTitle(D()(n().translator.trans("clarkwinkelmann-composer-page.forum.page"+(I()?"-private":"")+".title"))),n().setTitleCount(0),n().preloadedApiDocument();var r=n().session.user;if(!r)return this.loading=!0,void m.route.set(n().route("index"));if(!n().composer.bodyMatches(g())){n().composer.load(g(),{user:r}),n().composer.show();var s=n().composer.fields;if(s){var a=m.route.param(),i=a.title,c=a.content;i&&(s.title?s.title(i):s.title=S()(i)),c&&s.content&&s.content(c),"composeTag"===n().current.data.routeName&&this.currentTag().then((function(o){if(o){var e=o.parent();s.tags=e?[e,o]:[o]}else s.tags=[];m.redraw(),t.updateHeight()}))}}},s.view=function(){var o=I();return m(".ComposerPageContainer",{className:o?"ComposerPageContainer--private-discussion":""},m(".container",m(".sideNavContainer",[m("nav.IndexPage-nav.sideNav",m("ul",d()(b().prototype.sidebarItems().toArray()))),m(".sideNavOffset",m(".ComposerPage",[m("h2.App-titleControl",n().translator.trans("clarkwinkelmann-composer-page.forum.page"+(o?"-private":"")+".heading")),this.body()]))])))},s.body=function(){var o=n().composer.body;return!o.componentClass||this.loading?M().component():o.componentClass.component(P({},o.attrs,{composer:n().composer,disabled:!1}))},s.oncreate=function(e){var t=this;o.prototype.oncreate.call(this,e),$(window).on("resize",this.handlers.onresize=this.updateHeight.bind(this)),this.handlers.observer=new ResizeObserver(this.updateHeight.bind(this)),this.handlers.observer.observe(this.element.querySelector(".ComposerBody-header")),setTimeout((function(){t.updateHeight()}),10)},s.onremove=function(e){o.prototype.onremove.call(this,e),$(window).off("resize",this.handlers.onresize),this.handlers.observer.disconnect(),n().composer.bodyMatches(g())&&n().composer.minimize()},s.updateHeight=function(){var o=this.$(".Composer-flexible");if(o.length){var e=o.offset().top,t=parseInt(o.css("padding-bottom"),10),r=this.$(".Composer-footer").outerHeight(!0);o.height(Math.max(window.innerHeight-e-t-r,200))}},r}(T());function B(){var o=n().current.data.routeName;return"compose"===o||"composeTag"===o}function z(o){var e=n().forum.attribute("composerPageTags");return!e||e.split(",").some((function(e){return-1!==o.indexOf(e)}))}n().initializers.add("clarkwinkelmann-composer-page",(function(){n().routes.compose={path:"/compose",component:_},n().routes.composeTag={path:"/t/:slug/compose",component:_},(0,t.override)(h().prototype,"view",(function(o){return B()?m(".Composer",[m(".Composer-handle",{oncreate:this.configHandle.bind(this)}),m("ul.Composer-controls",d()(this.controlItems().toArray())),m(".Composer-handle"),m(".Composer-content")]):o()}));var o="[]";(0,t.extend)(h().prototype,"onupdate",(function(){var e=((n().composer.fields||{}).tags||[]).map((function(o){return o.slug()})),t=JSON.stringify(e);o!==t&&(n().composer.bodyMatches(g())&&z(e)&&!B()&&setTimeout((function(){n().composer.show()}),220),o=t)})),(0,t.override)(w().prototype,"show",(function(o){var e,t;if(!this.bodyMatches(g()))return o();var r=null==(e=flarum.extensions["fof-byobu"])||null==(e=e.discussions)?void 0:e.PrivateDiscussionComposer;return r&&this.bodyMatches(r)&&!n().forum.attribute("composerPagePrivateDiscussions")?o():z(((null==(t=this.fields)?void 0:t.tags)||[]).map((function(o){return o.slug()})))||B()?(this.position=w().Position.HIDDEN,void(B()||m.route.set(n().route("compose")))):o()})),(0,t.override)(w().prototype,"isVisible",(function(o){return!(!this.bodyMatches(g())||!B())||o()})),(0,t.override)(g().prototype,"oninit",(function(o,e){var t=e.attrs.composer.fields.content();o(e),this.composer.fields.content(t)})),(0,t.extend)(g().prototype,"view",(function(o){B()&&o.children.push(m(".ComposerPageMobileSubmit",a().component({icon:"fas fa-paper-plane",className:"Button Button--primary",onclick:this.onsubmit.bind(this)},this.attrs.submitLabel)))})),(0,t.extend)(b().prototype,"sidebarItems",(function(o){var e,t=o.get("newDiscussion");if(t&&n().session.user&&-1===(null==(e=t.attrs.itemClassName)?void 0:e.indexOf("fof-byobu_primaryControl"))){if(B())return t.attrs.className=t.attrs.className.replace("Button--primary",""),t.attrs.icon="fas fa-trash",delete t.attrs.itemClassName,void(t.children=n().translator.trans("clarkwinkelmann-composer-page.forum.nav.cancel"));if(n().composer.bodyMatches(g()))return t.attrs.className=t.attrs.className.replace("Button--tagColored",""),t.attrs.className=t.attrs.className.replace("Button--primary",""),t.attrs.style&&delete t.attrs.style["--color"],void(t.children=n().translator.trans("clarkwinkelmann-composer-page.forum.nav.continue"));var r=this.currentTag&&this.currentTag(),s=[];if(r){s.push(r.slug());var a=r.parent();a&&s.push(a.slug())}z(s)&&(t.tag=c(),t.attrs.href=r?n().route("composeTag",{slug:r.slug()}):n().route("compose"),delete t.attrs.onclick)}})),(0,t.override)(b().prototype,"newDiscussionAction",(function(o){return B()?(n().composer.close(),n().composer.body.componentClass||m.route.set(n().route("index")),Promise.resolve()):n().composer.bodyMatches(g())?(n().composer.show(),Promise.resolve()):o()})),(0,t.override)(u().prototype,"fofUploadDragAndDropTarget",(function(o){if(!o())return this.$(".TextEditor-editor")[0]}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map